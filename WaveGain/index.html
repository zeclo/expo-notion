<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>FFmpeg.wasm loudnorm bridge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h2 id="status">JS RUNNING3</h2>

  <!-- ffmpeg.wasm (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.15/dist/ffmpeg.min.js"></script>

  <script>
    const statusEl = document.getElementById('status');
    const { createFFmpeg } = FFmpeg;

    const ffmpeg = createFFmpeg({ log: true });
    let ffmpegLoaded = false;

    /* =========================
       共通ユーティリティ
    ========================= */

    function send(obj) {
      if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
        window.ReactNativeWebView.postMessage(JSON.stringify(obj));
      }
    }

    function base64ToUint8(b64) {
      const binary = atob(b64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes;
    }

    function uint8ToBase64(bytes) {
      let binary = '';
      const chunk = 0x8000;
      for (let i = 0; i < bytes.length; i += chunk) {
        binary += String.fromCharCode(...bytes.subarray(i, i + chunk));
      }
      return btoa(binary);
    }

    /* =========================
       READY を「必ず」送る
    ========================= */

    // ★ DOM & WebView が確実に準備できた後
    window.addEventListener('load', () => {
      statusEl.innerText = 'JS RUNNING3 (READY SENT)';
      send({ type: 'READY' });
    });

    /* =========================
       メッセージ受信
    ========================= */

    document.addEventListener('message', async (event) => {
      let data;
      try {
        data = JSON.parse(event.data);
      } catch {
        return;
      }

      // Expo 起動確認
      if (data.type === 'PING') {
        send({ type: 'READY' });
        return;
      }

      // 音声処理要求
      if (data.type === 'PROCESS') {
        try {
          if (!ffmpegLoaded) {
            statusEl.innerText = 'Loading FFmpeg...';
            await ffmpeg.load();
            ffmpegLoaded = true;
          }

          statusEl.innerText = 'Processing audio...';

          ffmpeg.FS(
            'writeFile',
            'input.wav',
            base64ToUint8(data.inputBase64)
          );

          await ffmpeg.run(
            '-i',
            'input.wav',
            '-af',
            'loudnorm',
            'output.wav'
          );

          const outBytes = ffmpeg.FS('readFile', 'output.wav');
          const outBase64 = uint8ToBase64(outBytes);

          statusEl.innerText = 'Done';

          send({
            type: 'RESULT',
            outBase64,
            mime: 'audio/wav',
          });
        } catch (e) {
          statusEl.innerText = 'ERROR';
          send({
            type: 'ERROR',
            message: String(e),
          });
        }
      }
    });
  </script>
</body>
</html>
