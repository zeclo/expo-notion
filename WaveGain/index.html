<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>FFmpeg.wasm loudnorm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h2 id="status">JS RUNNING3</h2>

  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.15/dist/ffmpeg.min.js"></script>

  <script>
    const statusEl = document.getElementById('status');
    const { createFFmpeg } = FFmpeg;

    const ffmpeg = createFFmpeg({ log: true });
    let loaded = false;

    function send(obj) {
      if (window.ReactNativeWebView?.postMessage) {
        window.ReactNativeWebView.postMessage(JSON.stringify(obj));
      }
    }

    function base64ToUint8(b64) {
      return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    }

    function uint8ToBase64(bytes) {
      return btoa(String.fromCharCode(...bytes));
    }

    async function loadFFmpeg() {
      statusEl.innerText = 'Loading FFmpeg...';
      await ffmpeg.load();
      loaded = true;
      statusEl.innerText = 'FFmpeg READY';
      send({ type: 'READY' });
    }

    document.addEventListener('message', async (event) => {
      let data;
      try {
        data = JSON.parse(event.data);
      } catch {
        return;
      }

      if (data.type === 'PING') {
        send({ type: 'READY' });
        return;
      }

      if (data.type === 'PROCESS') {
        try {
          if (!loaded) {
            await loadFFmpeg();
          }

          statusEl.innerText = 'Processing audio...';

          ffmpeg.FS(
            'writeFile',
            'input.wav',
            base64ToUint8(data.inputBase64)
          );

          await ffmpeg.run(
            '-i',
            'input.wav',
            '-af',
            'loudnorm',
            'output.wav'
          );

          const out = ffmpeg.FS('readFile', 'output.wav');
          const outBase64 = uint8ToBase64(out);

          statusEl.innerText = 'Done';

          send({
            type: 'RESULT',
            outBase64,
            mime: 'audio/wav',
          });
        } catch (e) {
          send({ type: 'ERROR', message: String(e) });
        }
      }
    });

    // 起動通知
    send({ type: 'ALIVE' });
  </script>
</body>
</html>
